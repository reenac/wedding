<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Wedding Uploads</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; max-width: 720px; }
    h1, h2 { margin: 0 0 8px; }
    p { margin: 0 0 16px; line-height: 1.4; }

    .card { border: 1px solid #ddd; border-radius: 12px; padding: 16px; margin: 16px 0; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }

    input[type="text"] {
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #ccc;
      flex: 1;
      min-width: 220px;
    }

    button {
      padding: 12px 14px;
      border: 0;
      border-radius: 10px;
      cursor: pointer;
    }

    button.primary { background: #111; color: #fff; }
    button.secondary { background: #eee; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }

    .small { color: #555; font-size: 0.95rem; }

    /* Upload progress */
    .progress {
      width: 100%;
      height: 12px;
      background: #eee;
      border-radius: 999px;
      overflow: hidden;
      margin-top: 10px;
    }

    .bar {
      height: 100%;
      width: 0%;
      background: #111;
      transition: width 0.2s ease;
    }

    .log {
      white-space: pre-wrap;
      background: #fafafa;
      border: 1px solid #eee;
      padding: 10px;
      border-radius: 10px;
      margin-top: 12px;
      font-size: 0.95rem;
    }

    .ok { color: #0a7; }
    .err { color: #c00; }

    /* Gallery */
    .gallery-grid {
      margin-top: 14px;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 12px;
    }

    .tile {
      border-radius: 12px;
      overflow: hidden;
      background: #f4f4f4;
    }

    .thumb {
      width: 100%;
      height: 180px;
      object-fit: cover;
      display: block;
      background: #ddd;
      cursor: pointer;
    }

    video.thumb {
      object-fit: cover;
    }
  </style>
</head>

<body>
  <h1>Upload wedding photos & videos</h1>
  <p class="small">No login needed. Please keep this link private (only share with wedding guests).</p>

  <!-- Upload card -->
  <div class="card">
    <div class="row">
      <input id="guestName" type="text" placeholder="Your name (optional)" />
      <button id="pickBtn" class="secondary" type="button">Choose files</button>
      <button id="uploadBtn" class="primary" type="button" disabled>Upload</button>
    </div>

    <input id="fileInput" type="file" multiple accept="image/*,video/*" style="display:none" />
    <div class="small" id="fileSummary" style="margin-top:10px;">No files selected.</div>

    <div class="progress">
      <div class="bar" id="bar"></div>
    </div>

    <div class="log" id="log">Ready.</div>
  </div>

  <!-- Gallery card -->
  <div class="card">
    <h2>Gallery</h2>
    <p class="small">Enter password and tap "Load gallery" to view recent uploads</strong>.</p>

    <div class="row">
      <input id="galleryPass" type="text" placeholder="Gallery password (if set)" />
      <button id="loadGalleryBtn" class="primary" type="button">Load gallery</button>
      <button id="refreshGalleryBtn" class="secondary" type="button" disabled>Refresh</button>
    </div>

    <div class="small" id="galleryStatus" style="margin-top:10px;">Not loaded yet.</div>
    <div id="gallery" class="gallery-grid"></div>
  </div>

<script>
  const SIGNED_URL_ENDPOINT = "https://us-west2-r-j-wedding.cloudfunctions.net/getSignedUploadUrl";
  const LIST_GALLERY_ENDPOINT = "https://us-west2-r-j-wedding.cloudfunctions.net/listGallery";
  const UPLOAD_PREFIX = "wedding-uploads";

  const fileInput = document.getElementById("fileInput");
  const pickBtn = document.getElementById("pickBtn");
  const uploadBtn = document.getElementById("uploadBtn");
  const fileSummary = document.getElementById("fileSummary");
  const guestNameEl = document.getElementById("guestName");
  const bar = document.getElementById("bar");
  const logEl = document.getElementById("log");

  const galleryEl = document.getElementById("gallery");
  const galleryPassEl = document.getElementById("galleryPass");
  const loadGalleryBtn = document.getElementById("loadGalleryBtn");
  const refreshGalleryBtn = document.getElementById("refreshGalleryBtn");
  const galleryStatusEl = document.getElementById("galleryStatus");

  let selectedFiles = [];

  function log(msg, cls="") {
    logEl.className = "log " + cls;
    logEl.textContent = msg;
  }

  function sanitizeName(s) {
    return (s || "").trim().replace(/\s+/g, "_").replace(/[^a-zA-Z0-9_\-\.]/g, "");
  }

  function humanBytes(bytes) {
    const units = ["B","KB","MB","GB","TB"];
    let b = bytes, i = 0;
    while (b >= 1024 && i < units.length-1) { b /= 1024; i++; }
    return `${b.toFixed(b >= 10 || i === 0 ? 0 : 1)} ${units[i]}`;
  }

  pickBtn.onclick = () => fileInput.click();

  fileInput.onchange = () => {
    selectedFiles = Array.from(fileInput.files || []);
    if (!selectedFiles.length) {
      fileSummary.textContent = "No files selected.";
      uploadBtn.disabled = true;
      return;
    }
    const total = selectedFiles.reduce((a,f)=>a+f.size,0);
    fileSummary.textContent = `${selectedFiles.length} file(s) selected â€” ${humanBytes(total)}`;
    uploadBtn.disabled = false;
    log("Ready to upload.");
  };

  async function getSignedUrl(payload) {
    const r = await fetch(SIGNED_URL_ENDPOINT, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    if (!r.ok) throw new Error(await r.text());
    return r.json();
  }

  uploadBtn.onclick = async () => {
    uploadBtn.disabled = true;
    pickBtn.disabled = true;
    bar.style.width = "0%";

    const guest = sanitizeName(guestNameEl.value);
    const d = new Date();
    const datePrefix = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;

    try {
      let done = 0;
      for (const file of selectedFiles) {
        const safe = sanitizeName(file.name);
        const key = `${UPLOAD_PREFIX}/${datePrefix}/${guest ? guest + "/" : ""}${Date.now()}_${Math.random().toString(16).slice(2)}_${safe}`;

        const { uploadUrl } = await getSignedUrl({ objectName: key, contentType: file.type });
        await fetch(uploadUrl, { method: "PUT", headers: { "Content-Type": file.type }, body: file });

        done++;
        bar.style.width = `${(done / selectedFiles.length) * 100}%`;
      }

      log("All uploads complete. Thank you! ðŸ’›", "ok");
      fileInput.value = "";
      selectedFiles = [];
      fileSummary.textContent = "No files selected.";

      if (!refreshGalleryBtn.disabled) loadGallery(true);
    } catch (e) {
      log(`Something went wrong:\n${e.message}`, "err");
    } finally {
      pickBtn.disabled = false;
      uploadBtn.disabled = true;
    }
  };

  function makeTile(item) {
    const t = document.createElement("div");
    t.className = "tile";

    if (item.contentType.startsWith("image/")) {
      const img = document.createElement("img");
      img.className = "thumb";
      img.src = item.url;
      img.onclick = () => window.open(item.url, "_blank");
      t.appendChild(img);
    } else {
      const v = document.createElement("video");
      v.className = "thumb";
      v.src = item.url;
      v.controls = true;
      v.preload = "metadata";
      t.appendChild(v);
    }
    return t;
  }

  async function loadGallery(refresh=false) {
    galleryEl.innerHTML = "";
    galleryStatusEl.textContent = refresh ? "Refreshingâ€¦" : "Loadingâ€¦";

    try {
      const r = await fetch(LIST_GALLERY_ENDPOINT, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ password: galleryPassEl.value || "" })
      });

      if (!r.ok) throw new Error(await r.text());
      const { items } = await r.json();

      if (!items.length) {
        galleryStatusEl.textContent = "No uploads yet.";
        return;
      }

      galleryStatusEl.textContent = `Showing ${items.length} most recent uploads.`;
      items.forEach(i => galleryEl.appendChild(makeTile(i)));
      refreshGalleryBtn.disabled = false;
    } catch (e) {
      galleryStatusEl.textContent = `Error loading gallery: ${e.message}`;
      refreshGalleryBtn.disabled = true;
    }
  }

  loadGalleryBtn.onclick = () => loadGallery(false);
  refreshGalleryBtn.onclick = () => loadGallery(true);
</script>
</body>
</html>
