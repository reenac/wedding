<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Wedding Uploads</title>

  <style>
    :root{
      --bg1:#fff7ef;
      --bg2:#fffdf9;
      --ink:#1f2328;
      --muted:#667085;
      --card-border: rgba(17,17,17,.10);

      --accent:#d97706;
      --accent2:#be123c;

      --shadow2: 0 10px 24px rgba(0,0,0,.08);
      --radius: 18px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }

    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--ink);
      background: linear-gradient(180deg, var(--bg1), var(--bg2));
      position: relative;
    }

    /* fixed decorative background (no harsh repeat on long pages) */
    body::before{
      content:"";
      position: fixed;
      inset: 0;
      z-index: -1;
      pointer-events: none;
      background:
        radial-gradient(1200px 700px at 10% 0%, rgba(217,119,6,.16), transparent 60%),
        radial-gradient(900px 600px at 90% 10%, rgba(190,18,60,.14), transparent 60%),
        radial-gradient(900px 600px at 60% 100%, rgba(15,118,110,.10), transparent 65%);
    }

    .wrap{
      max-width: 860px;
      margin: 0 auto;
      padding: 28px 18px 60px;
    }

    header{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:14px;
      margin-bottom: 22px;
      text-align:center;
    }

    /* PNG logo */
    .logo{
      width: min(360px, 80vw);
      height: auto;
      display:block;
    }

    h1{
      margin:0;
      font-family: "Georgia", "Times New Roman", serif;
      font-weight: 500;
      letter-spacing: 0.02em;
      font-size: clamp(18px, 2.6vw, 22px);
      text-transform: uppercase;
      color: #3b3b3b;
    }

    p{ margin:0; line-height: 1.5; }
    .small{ color:var(--muted); font-size: 0.98rem; }

    .card{
      margin: 16px 0;
      padding: 18px;
      border-radius: var(--radius);
      border: 1px solid var(--card-border);
      background: rgba(255,255,255,.88);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow2);
    }

    .card h2{
      margin:0 0 6px;
      font-size: 1.1rem;
    }

    .row{
      display:flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items:center;
    }

    input[type="text"],
    input[type="password"]{
      flex: 1;
      min-width: 220px;
      padding: 12px;
      border-radius: 14px;
      border: 1px solid rgba(17,17,17,.16);
      background: rgba(255,255,255,.92);
      outline: none;
    }

    input:focus{
      border-color: rgba(217,119,6,.55);
      box-shadow: 0 0 0 4px rgba(217,119,6,.16);
    }

    button{
      padding: 12px 14px;
      border-radius: 14px;
      cursor: pointer;
      font-weight: 600;
      border: 1px solid rgba(17,17,17,.12);
    }

    button.secondary{
      background: rgba(255,255,255,.95);
    }

    button.primary{
      color:#fff;
      border:none;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      box-shadow: 0 12px 26px rgba(190,18,60,.18);
    }

    button:disabled{ opacity:.55; cursor:not-allowed; }

    /* Upload progress */
    .progress{
      width:100%;
      height: 12px;
      background: rgba(17,17,17,.08);
      border-radius: 999px;
      overflow:hidden;
      margin-top: 12px;
      position: relative;
    }

    .bar{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      transition: width .25s ease;
    }

    /* animated ‚Äúworking‚Äù state (shows activity even when a single file takes time) */
    .progress.active .bar{
      width: 35%;
      animation: loading 1.2s infinite ease-in-out;
    }

    @keyframes loading{
      0%{ transform: translateX(-100%); }
      100%{ transform: translateX(300%); }
    }

    .log{
      margin-top: 12px;
      padding: 12px;
      border-radius: 14px;
      border: 1px solid rgba(17,17,17,.10);
      background: rgba(255,255,255,.92);
      white-space: pre-wrap;
      font-size: .98rem;
    }

    .ok{ color:#0f766e; }
    .err{ color:#be123c; }

    .gallery-grid{
      margin-top: 14px;
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(170px, 1fr));
      gap: 12px;
    }

    .tile{
      border-radius: 16px;
      overflow:hidden;
      border: 1px solid rgba(17,17,17,.10);
      background: rgba(255,255,255,.96);
      box-shadow: 0 10px 20px rgba(0,0,0,.08);
    }

    .thumb{
      width:100%;
      height: 190px;
      object-fit: cover;
      display:block;
      background:#ddd;
      cursor:pointer;
    }

    @media (max-width:520px){
      button{ flex:1; }
      .thumb{ height:170px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <!-- PNG logo (same folder as index.html) -->
      <img src="reena-jacob.png" alt="Reena & Jacob" class="logo" />
      <h1>Upload wedding photos &amp; videos</h1>
      <p class="small">No login needed. Please keep this link private (only share with wedding guests).</p>
    </header>

    <!-- Upload card -->
    <div class="card">
      <div class="row">
        <input id="guestName" type="text" placeholder="Your name (optional)" />
        <button id="pickBtn" class="secondary" type="button">Choose files</button>
        <button id="uploadBtn" class="primary" type="button" disabled>Upload</button>
      </div>

      <p class="small" id="uploadHint" style="margin-top:10px;">
        Videos may take a couple of minutes to upload. Please keep this page open.
      </p>

      <input id="fileInput" type="file" multiple accept="image/*,video/*" style="display:none" />
      <div class="small" id="fileSummary" style="margin-top:10px;">No files selected.</div>

      <div class="progress" id="progress">
        <div class="bar" id="bar"></div>
      </div>

      <div class="log" id="log">Ready.</div>
    </div>

    <!-- Gallery card -->
    <div class="card">
      <h2>Gallery</h2>
      <p class="small">Enter the password and tap ‚ÄúLoad gallery‚Äù to view recent uploads.</p>

      <div class="row" style="margin-top:12px;">
        <input id="galleryPass" type="password" placeholder="Password" />
        <button id="loadGalleryBtn" class="primary" type="button">Load gallery</button>
        <button id="refreshGalleryBtn" class="secondary" type="button" disabled>Refresh</button>
      </div>

      <div class="small" id="galleryStatus" style="margin-top:10px;">Not loaded yet.</div>
      <div id="gallery" class="gallery-grid"></div>
    </div>
  </div>

<script>
  const SIGNED_URL_ENDPOINT = "https://us-west2-r-j-wedding.cloudfunctions.net/getSignedUploadUrl";
  const LIST_GALLERY_ENDPOINT = "https://us-west2-r-j-wedding.cloudfunctions.net/listGallery";
  const UPLOAD_PREFIX = "wedding-uploads";

  const fileInput = document.getElementById("fileInput");
  const pickBtn = document.getElementById("pickBtn");
  const uploadBtn = document.getElementById("uploadBtn");
  const fileSummary = document.getElementById("fileSummary");
  const guestNameEl = document.getElementById("guestName");
  const progressEl = document.getElementById("progress");
  const bar = document.getElementById("bar");
  const logEl = document.getElementById("log");

  const galleryEl = document.getElementById("gallery");
  const galleryPassEl = document.getElementById("galleryPass");
  const loadGalleryBtn = document.getElementById("loadGalleryBtn");
  const refreshGalleryBtn = document.getElementById("refreshGalleryBtn");
  const galleryStatusEl = document.getElementById("galleryStatus");

  let selectedFiles = [];

  function log(msg, cls="") {
    logEl.className = "log " + cls;
    logEl.textContent = msg;
  }

  function setUploadingState(isUploading, text="") {
    progressEl.classList.toggle("active", isUploading);
    if (text) log(text);
  }

  function sanitizeName(s) {
    return (s || "").trim().replace(/\s+/g, "_").replace(/[^a-zA-Z0-9_\-\.]/g, "");
  }

  function humanBytes(bytes) {
    const units = ["B","KB","MB","GB","TB"];
    let b = bytes, i = 0;
    while (b >= 1024 && i < units.length-1) { b /= 1024; i++; }
    return `${b.toFixed(b >= 10 || i === 0 ? 0 : 1)} ${units[i]}`;
  }

  pickBtn.onclick = () => fileInput.click();

  fileInput.onchange = () => {
    selectedFiles = Array.from(fileInput.files || []);
    if (!selectedFiles.length) {
      fileSummary.textContent = "No files selected.";
      uploadBtn.disabled = true;
      return;
    }
    const total = selectedFiles.reduce((a,f)=>a+f.size,0);
    fileSummary.textContent = `${selectedFiles.length} file(s) selected ‚Äî ${humanBytes(total)}`;
    uploadBtn.disabled = false;
    log("Ready to upload.");
  };

  async function getSignedUrl(payload) {
    const r = await fetch(SIGNED_URL_ENDPOINT, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    if (!r.ok) throw new Error(await r.text());
    return r.json();
  }

  uploadBtn.onclick = async () => {
    uploadBtn.disabled = true;
    pickBtn.disabled = true;
    bar.style.width = "0%";

    setUploadingState(true, "Starting upload‚Ä¶ Please keep this page open.");

    const guest = sanitizeName(guestNameEl.value);
    const d = new Date();
    const datePrefix = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;

    try {
      let done = 0;

      for (const file of selectedFiles) {
        const safe = sanitizeName(file.name);
        const key = `${UPLOAD_PREFIX}/${datePrefix}/${guest ? guest + "/" : ""}${Date.now()}_${Math.random().toString(16).slice(2)}_${safe}`;

        log(`Uploading ${done + 1} of ${selectedFiles.length}‚Ä¶`);

        const { uploadUrl } = await getSignedUrl({ objectName: key, contentType: file.type });

        // Keep the animated state during the actual PUT (this is where large videos take time)
        setUploadingState(true);

        await fetch(uploadUrl, {
          method: "PUT",
          headers: { "Content-Type": file.type },
          body: file
        });

        done++;

        // Switch to determinate progress after each file finishes
        setUploadingState(false);
        bar.style.width = `${(done / selectedFiles.length) * 100}%`;
        log(`Uploaded ${done} of ${selectedFiles.length}.`);
      }

      setUploadingState(false);
      log("All uploads complete. Thank you! üíõ", "ok");

      fileInput.value = "";
      selectedFiles = [];
      fileSummary.textContent = "No files selected.";
    } catch (e) {
      setUploadingState(false);
      log(`Something went wrong:\n${e.message}`, "err");
    } finally {
      pickBtn.disabled = false;
      uploadBtn.disabled = true;
    }
  };

  function makeTile(item) {
    const t = document.createElement("div");
    t.className = "tile";

    if (item.contentType.startsWith("image/")) {
      const img = document.createElement("img");
      img.className = "thumb";
      img.src = item.url;
      img.loading = "lazy";
      img.onclick = () => window.open(item.url, "_blank");
      t.appendChild(img);
    } else {
      const v = document.createElement("video");
      v.className = "thumb";
      v.src = item.url;
      v.controls = true;
      v.preload = "metadata";
      t.appendChild(v);
    }
    return t;
  }

  async function loadGallery(refresh=false) {
    galleryEl.innerHTML = "";
    galleryStatusEl.textContent = refresh ? "Refreshing‚Ä¶" : "Loading‚Ä¶";

    try {
      const r = await fetch(LIST_GALLERY_ENDPOINT, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ password: galleryPassEl.value || "" })
      });

      if (!r.ok) throw new Error(await r.text());
      const { items } = await r.json();

      if (!items.length) {
        galleryStatusEl.textContent = "No uploads yet.";
        return;
      }

      galleryStatusEl.textContent = `Showing ${items.length} most recent uploads.`;
      items.forEach(i => galleryEl.appendChild(makeTile(i)));
      refreshGalleryBtn.disabled = false;
    } catch (e) {
      galleryStatusEl.textContent = `Error loading gallery: ${e.message}`;
      refreshGalleryBtn.disabled = true;
    }
  }

  loadGalleryBtn.onclick = () => loadGallery(false);
  refreshGalleryBtn.onclick = () => loadGallery(true);
</script>
</body>
</html>
